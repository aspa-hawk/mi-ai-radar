name: AI Radar Pro - Telegram
on:
  schedule:
    - cron: '0 */12 * * *'  # Cada 12 horas
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: pip install feedparser requests

      - name: Run AI Radar & Send to Replit
        env:
          RADAR_SECRET_KEY: ${{ secrets.RADAR_SECRET_KEY }}
        run: |
          python <<EOF
          import feedparser
          import requests
          from datetime import datetime, timedelta
          import html

          # =============== Fuentes confiables y relevantes ===============
          SOURCES = {
              # IA Generativa & Multimedia
              "ü§ñ Hugging Face (Video)": "https://huggingface.co/models?pipeline_tag=text-to-video&sort=modified&rss=true",
              "üñºÔ∏è Hugging Face (Image)": "https://huggingface.co/models?pipeline_tag=text-to-image&sort=modified&rss=true",
              "üîä Hugging Face (Audio)": "https://huggingface.co/models?pipeline_tag=text-to-speech&sort=modified&rss=true",
              "üåç Replicate New": "https://replicate.com/new/feed",
              "üé• Runway ML Blog": "https://runwayml.com/blog/feed",
              "üöÄ Futurepedia (New)": "https://www.futurepedia.io/new/feed",
              "üõ†Ô∏è There's An AI For That": "https://theresanaiforthat.com/ai.rss",

              # Deepfakes & Forensics
              "üïµÔ∏è Reality Defender": "https://realitydefender.com/blog/rss/",
              "üîç WeVerify (EU)": "https://weverify.eu/feed/",

              # Ciberseguridad + IA
              "üõ°Ô∏è MITRE ATLAS": "https://atlas.mitre.org/updates.rss",
              "üö® CISA AI Security": "https://www.cisa.gov/news.xml?field_topic_target_id[9751]=9751",
              "üíª The Hacker News": "https://feeds.feedburner.com/TheHackersNews",
              "üîê Krebs on Security": "https://krebsonsecurity.com/feed/",

              # Investigaci√≥n Acad√©mica
              "üî¨ arXiv CV": "http://arxiv.org/rss/cs.CV",
              "üîê arXiv Security": "http://arxiv.org/rss/cs.CR",
              "üß† arXiv AI": "http://arxiv.org/rss/cs.AI",
              "üìä arXiv HC": "http://arxiv.org/rss/cs.HC",
              "‚öõÔ∏è arXiv Quantum": "http://arxiv.org/rss/quant-ph",
              "üìà Papers With Code": "https://paperswithcode.com/rss/latest.xml",

              # Pol√≠tica & √âtica
              "üìú EU AI Act Tracker": "https://artificialintelligenceact.eu/feed/",
              "üá™üá∫ EU Digital Strategy": "https://digital-strategy.ec.europa.eu/en/rss/ai-act",

              # Comunidades & Early Signals
              "üé® r/StableDiffusion": "https://www.reddit.com/r/StableDiffusion/new/.rss",
              "ü§ñ r/MachineLearning": "https://www.reddit.com/r/MachineLearning/new/.rss",
              "üé≠ r/deepfakes": "https://www.reddit.com/r/deepfakes/new/.rss",

              # Startups & Productos
              "üî• Product Hunt (AI)": "https://www.producthunt.com/topics/ai/feed",
              "üìΩÔ∏è Vimeo Blog": "https://vimeo.com/blog/feed"
          }

          # =============== Palabras clave de alto impacto ===============
          IMPACT_KEYWORDS = [
              "deepfake", "zero-day", "exploit", "bypass", "launch", "release", "new model",
              "SOTA", "demo", "text-to-video", "video generation", "voice cloning",
              "generative video", "multimodal", "real-time", "open source", "detection",
              "AI security", "adversarial", "synthetic media", "forgery", "hallucination",
              "agent", "red teaming", "quantum", "AI Act", "forensic", "forgery", "bias"
          ]

          def has_high_signal(text):
              return any(kw in text.lower() for kw in IMPACT_KEYWORDS)

          cutoff = datetime.now() - timedelta(hours=24)
          alerts = []

          for category, url in SOURCES.items():
              try:
                  feed = feedparser.parse(url)
                  for entry in feed.entries:
                      pub = entry.published_parsed
                      if not pub:
                          continue
                      pub_date = datetime(*pub[:6])
                      if pub_date < cutoff:
                          continue

                      title = entry.title[:70]
                      link = entry.link
                      summary = getattr(entry, 'summary', '')

                      if has_high_signal(title + " " + summary):
                          # Escapar & y < para Telegram HTML
                          safe_title = html.escape(title)
                          alerts.append(f"‚Ä¢ <a href='{link}'>{safe_title}...</a> ({category})")
              except Exception as e:
                  print(f"[SKIP] {category}: {e}")

          # =============== Enviar a Replit ===============
          if alerts:
              # Limitar a 25 alertas para evitar saturaci√≥n
              top_alerts = alerts[:25]
              message = "üåå <b>AI Radar Gal√°ctico</b> ‚Äî Se√±ales de impacto (√∫ltimas 24h)\\n\\n" + "\\n".join(top_alerts)
              payload = {"message": message}
              headers = {
                  "X-Secret-Key": "${{ secrets.RADAR_SECRET_KEY }}",
                  "Content-Type": "application/json"
              }
              url = "https://4e07f84c-ee4c-4c6f-b44c-ac2c24a26797-00-1d3wg3s59c6zj.worf.replit.dev/ingest-alert"
              r = requests.post(url, json=payload, headers=headers, timeout=15)
              if r.status_code == 200:
                  print("‚úÖ Alerta enviada a Replit")
              else:
                  print(f"‚ùå Error Replit: {r.text}")
          else:
              print("üò¥ No se detectaron se√±ales de impacto en las √∫ltimas 24h.")
          EOF
